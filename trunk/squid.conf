####################################################################
# WELCOME TO SQUID-3.4
# Kofigurasi squid.3.4 dengan ssl_bump dan store-id
# Author	: Bandi Shippuden
# Email		: bandi.shippuden@gmail.com
####################################################################
## START KONFIGURASI
####################################################################
## TAG: ACCESS CONTROLS
####################################################################
acl localnet src 192.168.0.0/16
acl loop_302 http_status 302

acl SSL_ports port 443
acl Safe_ports port 80   			# http
acl Safe_ports port 8080			# http alt
acl Safe_ports port 8000
acl Safe_ports port 443 			# https
acl Safe_ports port 20 21  			# ftp
acl Safe_ports port 70   			# gopher
acl Safe_ports port 210   			# wais
acl Safe_ports port 1025-65535  		# unregistered ports
acl Safe_ports port 631   			# cups
acl Safe_ports port 10000  			# webmin
acl Safe_ports port 901   			# SWAT
acl Safe_ports port 280   			# http-mgmt
acl Safe_ports port 488   			# gss-http
acl Safe_ports port 591   			# filemaker
acl Safe_ports port 777   			# multiling http
acl PURGE method PURGE
acl CONNECT method CONNECT

acl QUERY urlpath_regex -i (hackshield|blank.html|infinity.js|hshield.da|renew_session_token.php|recaptcha.js|dat.asp|notice.swf|patchlist.txt|hackshield|captcha|reset.css|update.ver|notice.html|updates.txt|gamenotice|images.kom|patchinfo.xml|noupdate.ui|\.Xtp|\.htc)
acl QUERY urlpath_regex -i (server_patch.cfg.iop|core.swf|Loading.swf|resouececheck.sq|mainloading.swf|config.xml|gemmaze.swf|xml.png|size.xml|resourcesbar.swf|version.xml|version.list|delete.ini)

# Yahoo Massangger Option
acl ym dstdomain .messenger.yahoo.com .psq.yahoo.com
acl ym dstdomain .us.il.yimg.com .msg.yahoo.com .pager.yahoo.com
acl ym dstdomain .rareedge.com .ytunnelpro.com .chat.yahoo.com
acl ym dstdomain .voice.yahoo.com
acl ym dstdomain .skype.com .imvu.com
acl login-yahoo dstdomain .login.yahoo.com
acl ymregex url_regex yupdater.yim ymsgr myspaceim

############################################################################
# TUNING SQUID.3.4
############################################################################
acl store_yt_id url_regex -i youtube.*(ptracking|stream_204|player_204|gen_204).*(v\=|docid\=|video_id\=).*$
acl store_id_list_yt url_regex -i (youtube|googlevideo).*videoplayback\?
acl store_id_list_yt url_regex ^https?\:\/\/([0-9.]{4}|.*\.youtube\.com|.*\.googlevideo\.com|.*\.video\.google\.com)\/(get_video\?|videodownload\?|videoplayback.*id).*

acl store-id_list urlpath_regex -i dl\.sourceforge\.net
acl store-id_list urlpath_regex -i i[0-9]\.ytimg\.com
acl store-id_list urlpath_regex -i \.fbcdn\.net
acl store_id_list urlpath_regex -i [a-zA-Z]{2}[0-9]*\.4shared\.com\/download\/

acl store_id_list_domain_CDN url_regex ^https?:\/\/[a-zA-Z0-9\-\_\.\%]*(fbcdn|akamaihd)[a-zA-Z0-9\-\_\.\%]*net\/rsrc\.php\/(.*)
acl store_id_list_domain_CDN url_regex ^https?\:\/\/[a-z]+[0-9]\.google\.co(m|\.id)
acl store_id_list_domain_CDN url_regex ^http:\/\/\.www[0-9][0-9]\.indowebster\.com\/(.*)(rar|zip|flv|wm(a|v)|3gp|mp(4|3)|exe|msi|avi|(mp(e?g|a|e|1|2|3|4))|cab|exe)

acl dontstore url_regex ^http:\/\/(([\d\w-]*(\.[^\.\-]*?\..*?))(\/\mosalsal\/[\d]{4}\/.*\/)(.*\.flv))\?start.*
acl dontstore url_regex redbot\.org \.php
acl dontstore url_regex \.(aspx|php)\?
acl dontstore url_regex goldprice\.org\/NewCharts\/gold\/images\/.*\.png
acl dontstore url_regex google\.co(m|\.[a-z]{2})\/complete\/search\?
acl dontstore url_regex redirector\.([0-9.]{4}|.*\.youtube\.com|.*\.googlevideo\.com|.*\.video\.google\.com)\/(get_video\?|videodownload\?|videoplayback.*id|get_video_info\?|ptracking\?|player_204\?|stream_204\?).*
acl getmethod method GET

####################################################################
# Range Option
####################################################################
acl range_site url_regex -i \.netmarble\.co.\id\/(Modoo|sf2).*\.(zip|dfg)
acl range_site url_regex -i ^http:\/\/*.patch\.gemscool\.com\/.*dragonnest.*\/.*live.*\.pak$
acl range_site url_regex -i ^http\:\/\/download\.cdn\.mozilla\.net\/pub\/firefox\/.*\.(exe|mar).*$
acl range_site url_regex -i ^http:\/\/.*adobe\.com\/pub\/adobe.*\.exe

###################################################################
## TAG: Update Google Chrome
###################################################################
acl chrome-update url_regex -i ^https?\:\/\/cache\.pack\.google\.com\/(crx|edgedl)\/.*
http_access deny chrome-update

###################################################################
## TAG: ACCESS CONTROL
###################################################################
http_access allow manager localhost
http_access deny manager
http_access allow PURGE localhost
http_access deny PURGE
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access deny all

####################################################################
## TAG: SSL_BUMP OPTIONS
####################################################################
# always_direct allow all
include /etc/squid/sslbump_none.list
ssl_bump server-first all
dns_v4_first on

####################################################################
## TAG: NETWORK OPTIONS
####################################################################
http_port 3128 tproxy
http_port 3127
https_port 3129 tproxy ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=16MB cert=/etc/squid/ssl_certs/squid.pem key=/etc/squid/ssl_certs/squid.key

####################################################################
## TAG: OPTIONS RELATING TO EXTERNAL SSL_CRTD 
####################################################################
sslcrtd_program /usr/lib/squid/ssl_crtd -s  /var/lib/squid/ssl_db -M 16MB
sslcrtd_children 40
sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER

####################################################################
## TAG: ACL NO CACHE/FIX CACHE SQUID
####################################################################
cache deny QUERY
cache deny ym
always_direct allow ym login-yahoo ymregex

####################################################################
## TAG: ZPH QOS for NO Limit HIT trafick
####################################################################
qos_flows local-hit=0x30

####################################################################
## TAG: MEMORY CACHE OPTIONS
####################################################################
memory_pools off
cache_mem 512 MB
maximum_object_size_in_memory 1024 KB
memory_replacement_policy heap GDSF

####################################################################
## TAG: DISK CACHE OPTIONS
####################################################################
cache_replacement_policy heap LFUDA
store_dir_select_algorithm round-robin
minimum_object_size 0 bytes
maximum_object_size 10 GB
cache_swap_low 98
cache_swap_high 99

# DISK Cadangan
###################################################################
cache_dir aufs /cache-01 23000 5 256
cache_dir aufs /cache-02 23000 5 256
cache_dir aufs /cache-03 23000 5 256
cache_dir aufs /cache-04 23000 5 256
cache_dir aufs /cache-05 23000 5 256
cache_dir aufs /cache-06 23000 5 256

cache_dir aufs /cache_proxy-01 60000 14 256
cache_dir aufs /cache_proxy-02 60000 14 256
cache_dir aufs /cache_proxy-03 60000 14 256

###################################################################
## TAG: LOGFILE OPTIONS
###################################################################
access_log stdio:/tmp/access.log
cache_log /tmp/cache.log
cache_store_log none

####################################################################
# PATCH/LOG FILE OPTIONS
####################################################################
coredump_dir /var/spool/squid
icon_directory /usr/share/squid/icons
error_directory /usr/share/squid/errors/en

store_id_program /etc/squid/jaringan-stress.pl
store_id_children 40 startup=0 idle=5 concurrency=100

store_id_access deny dontstore
store_id_access deny !getmethod

store_id_access allow store_id_list_yt
store_id_access allow store_yt_id
store_id_access allow store_id_list_domain_CDN
store_id_access allow store-id_list
store_id_access deny all

####################################################################
# 302 HTTP Status O[tion
####################################################################
store_miss deny store_id_list_yt loop_302
send_hit deny store_id_list_yt loop_302

range_offset_limit none range_site

####################################################################
# DNS OPTIONS jika Menggunakan DNS Unbond/Bind
####################################################################
hosts_file /etc/hosts
dns_nameservers 127.0.0.1 192.168.10.251

####################################################################
# ADMINISTRATIVE PARAMETERS
####################################################################
cache_mgr bandi.shippuden@gmail.com
cache_effective_user proxy
cache_effective_group proxy
visible_hostname bandi-shippuden.admin.net
unique_hostname bandi-shippuden.admin.net

####################################################################
# REQUEST_HEADER_ACCESS OPTIONS
####################################################################
httpd_suppress_version_string on

####################################################################
## TAG: OPTIONS FOR TUNING THE CACHE
####################################################################
ipcache_low 98
ipcache_high 99
ipcache_size 8024						# 2x Besar RAM 
fqdncache_size 8024						# real RAM Hardware

#quick_abort_min 0 KB
#quick_abort_max 0 KB
#quick_abort_pct 98

store_avg_object_size 128 KB
negative_ttl 0 minute
positive_dns_ttl 6 hours
negative_dns_ttl 0 minute

half_closed_clients off
shutdown_lifetime 10 seconds

strip_query_terms off
icp_port 0
log_icp_queries off
client_db on
buffered_logs on

icp_hit_stale on
#query_icmp on
logfile_rotate 1

pipeline_prefetch on
pipeline_prefetch 100
offline_mode off

vary_ignore_expire on
reload_into_ims on

max_filedescriptors 65536

####################################################################
## TAG: ACL ADS/IKLAN BLOCK
####################################################################
#url_rewrite_program /usr/local/bin/squidGuard -c /usr/local/squidGuard/squidGuard.conf

####################################################################
# refresh pattern configuration here
####################################################################
refresh_pattern -i  \.(sc-|dl-|ex-|mh-|mst|dll)$                0  20% 1440
refresh_pattern -i (main.exe|notice.html)$                      0  20% 0
refresh_pattern -i (livescore.com|UpdaterModifier.exe|FreeStyle.exe|FSLauncher.exe) 0  20% 0
refresh_pattern (get_video|videoplayback|videodownload|\.flv).*(begin|start)\=[1-9][0-9]*       0 0% 0
refresh_pattern imeem.*\.flv  0 0% 0  override-lastmod override-expire
refresh_pattern -i (livescore.com|UpdaterModifier.exe|FreeStyle.exe|FSLauncher.exe) 0  20% 0
refresh_pattern -i (patch.*txt|patch.*ini|patch.*cfg|hackshield) 0 80% 518400 ignore-no-store ignore-private reload-into-ims

# refresh_pattern ^http://.*\.squid\.internal\/.* 525600 99% 525600 override-expire override-lastmod ignore-reload ignore-no-store ignore-must-revalidate ignore-private ignore-auth  store-stale

refresh_pattern .*(audio|video)\/mp4\.* 5259487 99% 5259487 ignore-reload override-expire override-lastmod ignore-must-revalidate  ignore-no-cache ignore-private ignore-no-store ignore-auth store-stale

# Youtube Video
refresh_pattern -i (get_video\?|videoplayback\?|videodownload\?) 241920 100% 241920 override-expire ignore-reload ignore-private ignore-no-cache

# Image Youtube
refresh_pattern -i (yimg|twimg)\.com 129600 100% 129600 override-expire ignore-reload ignore-no-cache reload-into-ims
refresh_pattern -i (ytimg|ggpht)\.com.*\.(jpg|png|swf|flv|mp3|gif|webp)	483840 100% 483840 override-expire ignore-reload reload-into-ims

refresh_pattern \.(ico|video-stats) 129600 100% 129600 override-expire override-lastmod ignore-reload ignore-no-cache ignore-private ignore-auth ignore-no-store store-stale
refresh_pattern ^https?\://(cbk|mt|khm|mlt)[0-9]?)\.google\.co(m|\.id) 241920 100% 241920 override-expire ignore-reload ignore-private store-stale
refresh_pattern ^https?\://(kh|khmdb|mw1)\.google\.com 241920 100% 241920 override-expire ignore-reload ignore-private store-stale
refresh_pattern ^https?\:\/\/[a-z]+[0-9]\.google\.co(m|\.id) 241920 100% 241920 override-expire ignore-reload ignore-private store-stale
refresh_pattern -i \.kompas\.com.*\.(jpg|png|gif|swf) 0 50% 1440 reload-into-ims
refresh_pattern -i ^http:\/\/.*kompas.com 0 0% 0 reload-into-ims

#images facebook
refresh_pattern -i fbstatic-a\.akamaihd\.net.*\.(jpg|png|gif|ico|css|js) 241920 80% 241920 override-expire ignore-reload reload-into-ims ignore-auth
refresh_pattern -i ((facebook.com)|(85.131.151.39))\.(jpg|png|gif) 241920 99% 241920 ignore-reload override-expire ignore-no-cache ignore-no-store store-stale
refresh_pattern -i fbcdn\.net\/.*\.((jp(e?g|e|2)|gif|pn[pg]|bm?|tiff?|ico|swf|css|js)|(jp(e?g|e|2)|gif|pn[pg]|bm?|tiff?|ico|swf|css|js)(\?|.*$)) 241920 99% 241920 ignore-no-cache ignore-no-store ignore-private override-expire override-lastmod reload-into-ims ignore-auth
refresh_pattern static\.(xx|ak)\.fbcdn\.net*\.(jpg|gif|png) 241920 99% 241920 ignore-reload override-expire ignore-no-cache ignore-no-store
refresh_pattern ^https?\:\/\/profile\.ak\.fbcdn.net*\.(jpg|gif|png) 241920 99% 241920 ignore-reload override-expire ignore-no-cache ignore-no-store

# Video Facebook
refresh_pattern -i \.video.ak.fbcdn.net.*\.(mp4|flv|mp3|amf)			10080 80% 43200 override-expire ignore-reload reload-into-ims ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate

# Game Facebook
refresh_pattern ^https?:\/\/apps.facebook.com 	10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store store-stale
refresh_pattern -i \.zynga-[1-9].*net			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.zynga.com				10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.farmville.com			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.ninjasaga.com			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.mafiawars.com			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.crowdstar.com 			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.popcap.com 			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.go-games.org			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.miniclipcdn.com		10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.llnwd.net				10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale
refresh_pattern -i \.cloudfront.net.*\.(swf|mp3|jpg|png|ico|wav|amf|zip|p3d|atf)($|\?)  0 50% 43200 reload-into-ims refresh-ims
refresh_pattern -i \.nordeus.com			10080 80% 43200 ignore-reload override-expire ignore-no-cache ignore-no-store ignore-must-revalidate store-stale

# Update Game Online
refresh_pattern -i \.pb.gemscool.com.*\.zip	10080 99% 43200 ignore-no-cache ignore-no-store ignore-must-revalidate reload-into-ims ignore-reload
refresh_pattern -i \.gemscool.com\/lsaga\/.*\.iop 10080 50% 43200 ignore-reload reload-into-ims ignore-no-cache
refresh_pattern -i \.netmarble.co.id.*\.(zip|exe)		10080 99% 43200 ignore-no-cache ignore-no-store ignore-must-revalidate reload-into-ims ignore-reload
refresh_pattern -i \.csonline.co.id.*\.nap 	10080 99% 43200 ignore-no-cache ignore-no-store ignore-must-revalidate reload-into-ims ignore-reload
refresh_pattern -i \.crossfire.web.id.*\.cab	10080 99% 43200 ignore-no-cache ignore-no-store ignore-must-revalidate reload-into-ims ignore-reload

# Update Antivirus
refresh_pattern -i eset.com.*\.(ver|nup) 10080 99% 43200 ignore-no-cache ignore-no-store reload-into-ims ignore-reload
refresh_pattern -i google.com.*\.(crx|exe)($|\?)	10080 99% 43200	ignore-no-cache ignore-no-store reload-into-ims ignore-reload ignore-private
	
# Windows Update
refresh_pattern windowsupdate.com.*\.(cab|exe)($|\?) 43200 99% 241920 ignore-no-cache ignore-no-store ignore-reload reload-into-ims store-stale
refresh_pattern update.microsoft.com.*\.(cab|exe)($|\?) 43200 99% 241920 ignore-no-cache ignore-no-store ignore-reload reload-into-ims store-stale
refresh_pattern download.microsoft.com.*\.(cab|exe)($|\?) 43200 99% 241920 ignore-no-cache ignore-no-store ignore-reload reload-into-ims store-stale
refresh_pattern download.windowsupdate.com.*\.(cab|exe)($|\?) 43200 99% 241920 ignore-no-cache ignore-no-store ignore-reload reload-into-ims store-stale

#IIX DOWNLOAD
refresh_pattern ^http:\/\/\.www[0-9][0-9]\.indowebster\.com\/(.*)(mp3|rar|zip|flv|wmv|3gp|mp(4|3)|exe|msi|zip) 43200 99% 241920 reload-into-ims ignore-reload override-expire ignore-no-cache ignore-no-store store-stale ignore-auth

# Ads/Safe Browser
refresh_pattern ^.*safebrowsing.*google   131400 100% 525600 override-expire ignore-reload ignore-no-cache ignore-no-store ignore-private ignore-auth ignore-must-revalidate store-stale
refresh_pattern ^.*(streamate.doublepimp.com.*\.js\?|utm\.gif|ads\?|rmxads\.com|ad\.z5x\.net|bh\.contextweb\.com|bstats\.adbrite\.com|a1\.interclick\.com|ad\.trafficmp\.com|ads\.cubics\.com|ad\.xtendmedia\.com|\.googlesyndication\.com|advertising\.com|yieldmanager|game-advertising\.com|pixel\.quantserve\.com|adperium\.com|doubleclick\.net|adserving\.cpxinteractive\.com|syndication\.com|media.fastclick.net).* 241920 20% 241920 ignore-no-cache ignore-no-store ignore-private override-expire ignore-reload ignore-auth ignore-must-revalidate store-stale max-stale=1440

# Mediafire
refresh_pattern -i \.mediafire.com.*\.(jpg|png|gif|swf|mp3|ico|flv|zip|rar) 10080 100% 43200 override-expire ignore-reload reload-into-ims ignore-no-cache ignore-private ignore-no-store ignore-must-revalidate store-stale

# 4Shared
refresh_pattern ^http:\/\/[a-zA-Z]{2}\d*\.4shared\.com(:8080|)\/download\/(.*)\/(.*\..*)\?.* 10080 99% 60480 ignore-no-cache ignore-no-store ignore-private override-expire override-lastmod reload-into-ims store-stale
refresh_pattern ^http\:\/\/static\.4shared\.com\/.*\.(jpe?g|swf|png|ico|css|js|gif|wmv|avi|mp3|mp4|3gp|flv) 10080 99% 43200 ignore-reload reload-into-ims  store-stale
refresh_pattern ^http://download.*\.4shared\.com/ 10080 99% 241920 override-expire reload-into-ims ignore-private ignore-no-cache store-stale

# All File
refresh_pattern -i \.(3gp|7z|ace|asx|bin|deb|divx|dvr-ms|ram|rpm|exe|inc|cab|qt)\? 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims
refresh_pattern -i \.(rar|jar|gz|tgz|bz2|iso|m1v|m2(v|p)|mo(d|v)|arj|lha|lzh|zip|tar|iop|nzp|pak|mar)\? 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims ignore-reload
refresh_pattern -i \.(jp(e?g|e|2)|gif|pn[pg]|bm?|tiff?|ico|swf|dat|ad|txt|dll)\? 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims
refresh_pattern -i \.(avi|ac4|mp(e?g|a|e|1|2|3|4)|mk(a|v)|ms(i|u|p)|og(x|v|a|g)|rm|r(a|p)m|snd|vob|webm)\? 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims
refresh_pattern -i \.(pp(t?x)|s|t)|pdf|rtf|wax|wm(a|v)|wmx|wpl|cb(r|z|t)|xl(s?x)|do(c?x)|flv|x-flv)\? 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims

# All File
refresh_pattern -i \.(3gp|7z|ace|asx|bin|deb|divx|dvr-ms|ram|rpm|exe|inc|cab|qt) 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims
refresh_pattern -i \.(rar|jar|gz|tgz|bz2|iso|m1v|m2(v|p)|mo(d|v)|arj|lha|lzh|zip|tar|iop|nzp|pak|mar) 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims ignore-reload
refresh_pattern -i \.(jp(e?g|e|2)|gif|pn[pg]|bm?|tiff?|ico|swf|dat|ad|txt|dll) 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims
refresh_pattern -i \.(avi|ac4|mp(e?g|a|e|1|2|3|4)|mk(a|v)|ms(i|u|p)|og(x|v|a|g)|rm|r(a|p)m|snd|vob|webm) 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims
refresh_pattern -i \.(pp(t?x)|s|t)|pdf|rtf|wax|wm(a|v)|wmx|wpl|cb(r|z|t)|xl(s?x)|do(c?x)|flv|x-flv) 10080 80% 10080 ignore-no-cache override-expire override-lastmod reload-into-ims

refresh_pattern ^ftp: 		40320   20%     40320   override-expire reload-into-ims store-stale
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern . 0 50% 40320 override-expire reload-into-ims 

request_header_access Range deny store_id_list_yt store_yt_id
request_header_access Content-Range deny store_id_list_yt store_yt_id
request_header_access Accept-Ranges deny store_id_list_yt store_yt_id

request_header_access From deny all
request_header_access Server deny all
request_header_access WWW-Authenticate deny all
request_header_access Link deny all
request_header_access Cache-Control deny all
request_header_access Proxy-Connection deny all
request_header_access X-Cache deny all
request_header_access X-Cache-Lookup deny all
request_header_access Via deny all
request_header_access Forwarded-For deny all
request_header_access X-Forwarded-For deny all
request_header_access Pragma deny all
request_header_access Keep-Alive deny all
request_header_access Accept-Encoding deny all
